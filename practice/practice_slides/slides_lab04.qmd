---
title: "Lab 4:Mapping causal & predictive approaches"
subtitle: "<span style='font-size:2em;'> Practice session covering topics discussed in Lecture 4 </span>"
author: "<a href='https://r4biostats.com/me.html' style='color:#72aed8;font-weight:600;'>M. Chiara Mimmi, Ph.D.</a>&ensp;|&ensp;Università degli Studi di Pavia"
date: 2024-07-27
date-format: long
code-link: true
format:
  revealjs:
    smaller: true
    scrollable: true
    theme: ../../theme/slidesMine.scss # QUARTO LOOKS IN SAME FOLDER 
#    logo: imgs_slides/mitgest_logo.png
    footer: '[R 4 Biostatistics](https://r4biostats.com/) | MITGEST::training(2024)'
#    footer: <https://lulliter.github.io/R4biostats/lectures.html>
## ------------- x salvare come PDF 
    standalone: false
    ## -------Produce a standalone HTML file with no external dependencies,
    embed-resources: true
    transition: fade
    background-transition: fade
    highlight-style: ayu-mirage
    slide-number: true
    fig-cap-location: top
    # fig-format: svg
    pdf-separate-fragments: false
    # fig-align: center
execute:
  # Quarto pre code blocks do not echo their source code by default
  echo: true
  include: true
  freeze: auto
bibliography: ../../bib/R4biostats.bib
csl: ../../bib/apa-6th-edition.csl 
suppress-bibliography: true
---

# [GOAL OF TODAY'S PRACTICE SESSION]{.r-fit-text}

::: {style="font-size: 100%;"}
::: {style="color:#77501a"}
+ ...
:::
:::

<br><br>

::: {style="font-size: 70%;"}
The examples and datasets in this Lab session follow very closely two sources:

1. ...
:::


## Topics discussed in Lecture # 4


::: {style="font-size: 95%;"}
**Lecture 4: topics** 
<!-- + Shifting the emphasis on **empirical prediction**  -->
<!--   + Distinction between supervised & **unsupervised** algorithms -->
<!--     + Unsupervised ML Example -->
<!--       + PCA  -->

+ ....

<!-- + Workshop Conclusions -->

:::  

# R ENVIRONMENT SET UP & DATA

## Needed R Packages
::: {style="font-size: 85%;"}

+ We will use functions from packages `base`, `utils`, and `stats` (pre-installed and pre-loaded) 
+ We may also use the packages below (specifying `package::function` for clarity).


```{r}
# Load pckgs for this R session

# --- General 
library(here)     # tools find your project's files, based on working directory
library(dplyr)    # A Grammar of Data Manipulation
library(skimr)    # Compact and Flexible Summaries of Data
library(magrittr) # A Forward-Pipe Operator for R 
library(readr)    # A Forward-Pipe Operator for R 

# Plotting & data visualization
library(ggplot2)      # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggfortify)     # Data Visualization Tools for Statistical Analysis Results


library(dagitty)
library(ggdag)
library(patchwork)
library(broom)
library(data.table)
library(simstudy)
library(gridExtra)
#library(epiR)
#library(tableone)
#library(ipw)
library(sandwich) #for robust variance estimation
library(survey)
library(haven)

#library(EValue)
```

<!-- # Data  -->
<!-- # devtools::install_github("OI-Biostat/oi_biostat_data") -->
<!-- #library(oibiostat) # Data Package for OpenIntro Biostatistics  -->
:::

# DATASETS for today

<br>

::: {style="font-size: 80%;"}
In this tutorial, we will use: 

+ ....

:::


## [Dataset on ....]{.r-fit-text}

::: {style="font-size: 95%;"}
**Name**: ....  
**Documentation**: See reference on the data downloaded and ....
**Sampling details**: This .... 
::: 

## [Importing Dataset `...`]{.r-fit-text}
 
## [`....` variables with description]{.r-fit-text}

::: {style="font-size: 80%;"}
<!-- [[EXCERPT: see complete file in Input Data Folder]]{style="color:#77501a"} -->

```{r}
#| output: true
#| echo: false

biopsy_desc <- tibble::tribble(
  ~Variable, ~ Type, ~Description,
#"X" ,  "integer" ,         "row counter ", 
        
"class", "factor"     ,        "benign or malignant" )                 

kableExtra::kable(biopsy_desc)
```
:::

https://bookdown.org/jbrophy115/bookdown-clinepi/confounding.html

## DAG to represent confounders

```{r}
#| output-location: slide
 
dag <- dagitty::dagitty("dag {
  X -> Y
  Z -> X
  Z -> Y
  e -> Y
               }")

dagitty::coordinates(dag ) <-  list(
  x=c(X=1, Z=3, Y=5, e=5),
  y=c(X=1, Z=3, Y=1, e=3))

library(ggdag)
dag <-  tidy_dagitty(dag)
ex1 <-  ggdag(dag, layout = "circle") + 
  theme_dag_blank(plot.caption = element_text(hjust = 1)) + 
  geom_dag_node(color="pink") + 
  geom_dag_text(color="white") +
  ggtitle("a) DAG with a confounder (Z)") +
  labs(caption = "X = drug exposure\nY = outcome\nZ = confounder\n e = random error")
ex1
```

## ITE 

Individual Treatment Effect (ITE) is defined as the difference in potential outcomes for a given individual 
$ITE_i= y_{i}^1  − y_{i}^0$

The Causal Effect (CE)
 
$CE_i = Y_{1i} - Y_{0i}$ where $Y_{1i}$ and $Y_{0i}$ are the potential outcomes for each individual $i$ being *both* exposed and not exposed respectively (not possible in the real world).

Simulation 

```{r}
def <- defData(varname = "C", formula = 0.4, dist = "binary")
def <- defData(def, "X", formula = "0.3 + 0.4 * C", dist = "binary")
def <- defData(def, "e", formula = 0, variance = 2, dist = "normal")
def <- defData(def, "Y0", formula = "2 * C + e", dist="nonrandom")
def <- defData(def, "Y1", formula = "1 + 2 * C + e", dist="nonrandom")
def <- defData(def, "Y_obs", formula = "Y0 + (Y1 - Y0) * X", dist = "nonrandom") #  = Y1*X + (1-X)*Y0

set.seed(2017)
dt <- genData(10000, def)
```

```{r}
paste0("Calculated mean causal effect = ", mean(dt[, Y1] - dt[, Y0])) #mean difference of counterfactual outcomes
paste0("Calculated observed difference  = ", round(dt[X == 1, mean(Y_obs)] - dt[X == 0, mean(Y_obs)],2))

lm1 <- lm(Y_obs ~ X, data = dt)
tidy(lm1)
```


## Final thoughts

::: {style="font-size: 95%;"}
::: {style="color:#77501a"}


+ .....

:::

:::

